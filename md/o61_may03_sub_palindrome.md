วิธีการต่อไปนี้ จะนับคำตอบเฉพาะ Palindrome ที่มีความยาวเป็นจำนวนเต็มคี่เท่านั้น สำหรับความยาวที่เป็นจำนวนเต็มคู่ จะใช้วิธีการคล้ายกัน

กำหนดให้ $a_i$ คือตัวอักษรตัวที่ $i$ ของสายอักขระที่โจทย์ให้มา และ $p_i$ คือความยาวที่มากที่สุดที่ $a_{i - p_i - 1} \, a_{i - p_i} \, \dots \, a_{i + p_i - 2} \, a_{i + p_i - 1}$ เป็น Palindrome หรือครึ่งหนึ่งของขนาด Palindrome ที่ยาวที่สุดที่มีจุดศูนย์กลางเป็น $i$ นั่นเอง

แต่ละคำถามของโจทย์ เราจะได้ว่าคำตอบคือ $\sum \limits_{l \leq i \leq r} min(p_i, i - l + 1, r - i + 1)$ เนื่องจากจำนวน Palindrome ที่มีจุดศูนย์กลางเป็น $i$ คือ $p_i$ แต่เราจะนับเฉพาะ Palindrome ที่ไม่เลยช่วง $[l, r]$

กำหนดให้ $mid = \lfloor \frac{l + r}{2} \rfloor$ จะสังเกตได้ว่าค่าของ $i - l + 1$ จะน้อยกว่า $r - i + 1$ เมื่อ $i \leq mid$ และจะมากกว่าเมื่อ $i > mid$ ทำให้เราจำเป็นต้องเทียบ $p_i$ กับค่าใดค่าหนึ่งเท่านั้น ดังนั้น เราจึงสามารถจัดรูปคำตอบของคำถามเป็น $[\sum \limits_{l \leq i \leq mid} min(p_i, i - l + 1)] + [\sum \limits_{mid < i \leq r} min(p_i, r - i + 1)]$

สำหรับผลรวมด้านซ้าย เราจะสามารถจัดรูปเป็น $\sum \limits_{l \leq i \leq mid} min(p_i - i, 1 - l) + i$ หรือ $[\sum \limits_{l \leq i \leq mid} min(p_i - i, 1 - l)] + \frac{(l + mid)(mid - l + 1)}{2}$ ได้

ในทำนองเดียวกัน ผลรวมด้านขวาก็สามารถจัดรูปเป็น $\sum \limits_{mid < i \leq r} min(p_i + i, 1 + r) - i$ หรือ $[\sum \limits_{mid < i \leq r} min(p_i + i, 1 + r)] + \frac{(mid + 1 + r)(r - mid)}{2}$ ได้

ดังนั้น ในแต่ลำคำถาม เราจำเป็นต้องทราบค่าของ $\sum \limits_{l \leq i \leq mid} min(p_i - i, 1 - l)$ และ $\sum \limits_{mid < i \leq r} min(p_i + i, 1 + r)$ ซึ่งสามารถหาค่าได้ด้วยการใช้ Persistent Segment Tree ภายในเวลา $\mathcal{O}(\log n)$

สำหรับผลรวมแรก เราจะทำการสร้าง Segment Tree จำนวน $2n$ ต้นที่รองรับการหาผลรวมเป็นช่วง โดย $n$ ต้นที่ $k$ ช่องที่ $j$ จะเก็บค่า $p_j - j$ เมื่อค่า $p_j - j$ มีตำแหน่งไม่เกิน $k$ ในอาร์เรย์ที่ประกอบไปด้วยค่า $p_i - i$ และเรียงจากน้อยไปมาก หรือ $0$ ในทางตรงกันข้าม ในทำน้องเดียวกัน Segment Tree ต้นที่ $n + i$ จะเก็บค่า $1$ หรือ $0$ โดยใช้เงื่อนไขเดียวกับ $n$ ต้นแรก สังเกตว่า Segment Tree ต้นที่ $i$ และ $i + 1$ จะมีสมาชิกที่มีค่าต่างกันเพียง 1 ตำแหน่งเท่านั้น เราจึงสามารถใช้ Persistent Segment Tree ในการเก็บค่าเหล่านี้ได้

กำหนดให้ $k$ คือค่าที่มากที่สุดที่ค่าของ $p_i - i$ ลำดับที่ $k$ จากน้อยไปมาก มีค่าไม่เกิน $1 - l$, $A$ เป็นผลรวมของช่วง $[l, r]$ ใน Segment Tree ต้นที่ $k$ และ $B$ เป็นผลรวมของช่วง $[l, r]$ ของ Segment Tree ต้นที่ $n + k$ จะได้ว่า $\sum \limits_{l \leq i \leq mid} min(p_i - i, 1 - l)$ จะมีค่าเท่ากับ $A + (1 - l)(mid - l + 1 - B)$ เพราะ $A$ คือผลรวมของ $p_i - i$ ที่มีค่าไม่เกิน $1 - l$ และ $B$ คือจำนวนช่องที่มีค่า $p_i - i$ ไม่เกิน $1 - l$ นั่นเอง

เราจะใช้วิธีเดียวกันในการหาค่าของ $\sum \limits_{mid < i \leq r} min(p_i + i, 1 + r)$ ทำให้ต้องสร้าง Segment Tree จำนวน $4n$ ต้น

นำค่าทั้งสองนี้รวมกับ $\frac{(l + mid)(mid - l + 1)}{2} + \frac{(mid + 1 + r)(r - mid)}{2}$ จะได้คำตอบของคำถามนั้น

Time Complexity: $\mathcal{O}(n \log n)$
